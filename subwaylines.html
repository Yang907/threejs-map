<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>地铁线路图</title>
  </head>
  <body>
    <div id="line-container"></div>

    <script src="lineData.js"></script>
    <script type="module">
      import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

      let labels = [];
      function init() {
        const svg = d3
          .select("#line-container")
          .append("svg")
          .attr("width", "100%")
          .attr("height", "100vh");
        const g = svg.append("g");

        // 3. 启用缩放行为
        const zoom = d3
          .zoom()
          .scaleExtent([0.5, 8]) // 限制缩放范围（最小0.5倍，最大8倍）
          .on("zoom", (event) => {
            // 当缩放或平移时，更新<g>的transform属性
            g.attr("transform", event.transform);
          });
        // 将缩放行为绑定到SVG
        svg.call(zoom);

        const curveGenerator = d3
          .line()
          .x((d) => d.position.x)
          .y((d) => d.position.y)
          .curve(d3.curveCatmullRom); // 使用曲线

        lineData.forEach((item) => {
          // 连线
          g.append("path")
            .datum(item.siteList)
            .attr("d", curveGenerator)
            .attr("stroke", item.lineColor)
            .attr("stroke-width", 6)
            .attr("fill", "none");

          // 标记站点
          g.selectAll("circle")
            .data(item.siteList)
            .enter()
            .append("circle")
            .attr("cx", (d) => d.position.x)
            .attr("cy", (d) => d.position.y)
            .attr("r", (r) => (r.siteName === "延长线" ? 10 : 3))
            .attr("fill", (r) =>
              r.siteName === "延长线" ? item.lineColor : "white"
            );

          // 2. 添加文字标签
          g.selectAll("text")
            .data(item.siteList)
            .enter()
            .append("text")
            .text((d) => (d.siteName === "延长线" ? item.lineCode : d.siteName))
            .attr("x", (d) =>
              d.siteName === "延长线" ? d.position.x : d.position.x
            ) // 文字向右偏移，避免重叠
            .attr("y", (d) =>
              d.siteName === "延长线" ? d.position.y - 6 : d.position.y + 5
            ) // 微调垂直位置
            .style("writing-mode", "vertical-rl") // 竖排从右到左
            .style("text-orientation", "upright") // 保持字符直立
            .attr("font-size", "12px")
            .attr("fill", (d) => (d.siteName === "延长线" ? "white" : "black"));
        });
      }

      // 2. 计算延迟拐弯的路径
      function createDelayedCurve(points, extension = 30) {
        const [p0, p1, p2] = points;

        // 计算前后线段的角度
        const angleIn = Math.atan2(p1.y - p0.y, p1.x - p0.x);
        const angleOut = Math.atan2(p2.y - p1.y, p2.x - p1.x);

        // 创建虚拟控制点（沿原方向延伸）
        const virtualBefore = {
          x: p1.x + Math.cos(angleIn) * extension,
          y: p1.y + Math.sin(angleIn) * extension,
        };

        const virtualAfter = {
          x: p1.x + Math.cos(angleOut) * extension,
          y: p1.y + Math.sin(angleOut) * extension,
        };

        // 构建三次贝塞尔曲线路径
        const path = d3.path();
        path.moveTo(p0.x, p0.y);
        path.bezierCurveTo(
          virtualBefore.x,
          virtualBefore.y, // 控制点1
          virtualAfter.x,
          virtualAfter.y, // 控制点2
          p2.x,
          p2.y // 终点
        );

        return path.toString();
      }

      init();
    </script>
  </body>
</html>
